<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simulateur TPI - Terrains Kamil</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 20px;
            color: #333;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #1a365d;
            margin-bottom: 10px;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
        }
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .section h2 {
            color: #2c5282;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        .hypotheses {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .hypothese {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        .hypothese label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        .hypothese input {
            width: 100%;
            padding: 8px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px 8px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
            font-size: 13px;
        }
        th {
            background: #edf2f7;
            font-weight: 600;
            color: #2d3748;
            text-align: center;
        }
        td:first-child, th:first-child {
            text-align: left;
        }
        .highlight {
            background: #fff5f5;
            font-weight: 600;
        }
        .highlight-green {
            background: #f0fff4;
        }
        .highlight-orange {
            background: #fffaf0;
        }
        .total-row {
            background: #2c5282;
            color: white;
            font-weight: 700;
        }
        .total-row td {
            border-bottom: none;
        }
        .negative {
            color: #c53030;
        }
        .positive {
            color: #276749;
        }
        .warning-box {
            background: #fff5f5;
            border: 1px solid #fc8181;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .warning-box h3 {
            color: #c53030;
            margin-bottom: 10px;
        }
        .info-box {
            background: #ebf8ff;
            border: 1px solid #63b3ed;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .info-box h3 {
            color: #2b6cb0;
            margin-bottom: 10px;
        }
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }
        .summary-card.danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        }
        .summary-card.success {
            background: linear-gradient(135deg, #48bb78 0%, #276749 100%);
        }
        .summary-card .label {
            font-size: 14px;
            opacity: 0.9;
        }
        .summary-card .value {
            font-size: 28px;
            font-weight: 700;
            margin-top: 5px;
        }
        .summary-card .detail {
            font-size: 12px;
            opacity: 0.8;
            margin-top: 5px;
        }
        .per-person {
            margin-top: 30px;
        }
        .person-section {
            background: #f7fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .person-section h3 {
            color: #2c5282;
            margin-bottom: 10px;
        }
        input:focus {
            outline: none;
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        .note {
            font-size: 11px;
            color: #718096;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Simulateur TPI - Terrains Famille</h1>
        <p class="subtitle">Calcul de la Taxe sur le Profit Immobilier pour chaque lot</p>

        <!-- Hypoth√®ses globales -->
        <div class="section">
            <h2>üìã Hypoth√®ses √† renseigner</h2>
            <div class="hypotheses">
                <div class="hypothese">
                    <label>Ann√©e donation Lot 1</label>
                    <input type="number" id="anneeDonation" value="2000" onchange="recalculer()">
                </div>
                <div class="hypothese">
                    <label>Valeur d√©clar√©e donation (MAD/m¬≤)</label>
                    <input type="number" id="valeurDonation" value="200" onchange="recalculer()">
                </div>
                <div class="hypothese">
                    <label>Ann√©e h√©ritage Lots 2-4</label>
                    <input type="number" id="anneeHeritage" value="2015" onchange="recalculer()">
                </div>
                <div class="hypothese">
                    <label>Valeur d√©clar√©e h√©ritage (MAD/m¬≤)</label>
                    <input type="number" id="valeurHeritage" value="200" onchange="recalculer()">
                </div>
                <div class="hypothese">
                    <label>Prix r√©f√©rentiel DGI (MAD/m¬≤)</label>
                    <input type="number" id="prixDGI" value="20000" onchange="recalculer()">
                    <p class="note">Si la DGI rectifie le prix</p>
                </div>
                <div class="hypothese">
                    <label>Ann√©e de vente</label>
                    <input type="number" id="anneeVente" value="2025" onchange="recalculer()">
                </div>
            </div>
        </div>

        <!-- Tableau des terrains -->
        <div class="section">
            <h2>üèûÔ∏è D√©tail des terrains</h2>
            <table>
                <thead>
                    <tr>
                        <th>Lot</th>
                        <th>Type</th>
                        <th>Surface (m¬≤)</th>
                        <th>Ali %</th>
                        <th>Amina %</th>
                        <th>Leila %</th>
                        <th>Prix vente/m¬≤</th>
                        <th>Valeur totale</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><strong>Lot 1</strong></td>
                        <td>Donation</td>
                        <td><input type="number" id="surface1" value="1577" onchange="recalculer()" style="width:80px"></td>
                        <td>100%</td>
                        <td>-</td>
                        <td>-</td>
                        <td><input type="number" id="prix1" value="18000" onchange="recalculer()" style="width:80px"></td>
                        <td id="valeur1">-</td>
                    </tr>
                    <tr>
                        <td><strong>Lot 2</strong></td>
                        <td>H√©ritage</td>
                        <td><input type="number" id="surface2" value="1425" onchange="recalculer()" style="width:80px"></td>
                        <td>-</td>
                        <td>50%</td>
                        <td>50%</td>
                        <td><input type="number" id="prix2" value="17000" onchange="recalculer()" style="width:80px"></td>
                        <td id="valeur2">-</td>
                    </tr>
                    <tr>
                        <td><strong>Lot 3</strong></td>
                        <td>H√©ritage</td>
                        <td><input type="number" id="surface3" value="1373" onchange="recalculer()" style="width:80px"></td>
                        <td>50%</td>
                        <td>25%</td>
                        <td>25%</td>
                        <td><input type="number" id="prix3" value="17000" onchange="recalculer()" style="width:80px"></td>
                        <td id="valeur3">-</td>
                    </tr>
                    <tr>
                        <td><strong>Lot 4</strong></td>
                        <td>H√©ritage</td>
                        <td><input type="number" id="surface4" value="1213" onchange="recalculer()" style="width:80px"></td>
                        <td>50%</td>
                        <td>25%</td>
                        <td>25%</td>
                        <td><input type="number" id="prix4" value="17000" onchange="recalculer()" style="width:80px"></td>
                        <td id="valeur4">-</td>
                    </tr>
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td></td>
                        <td id="totalSurface">-</td>
                        <td colspan="3"></td>
                        <td></td>
                        <td id="totalValeur">-</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Calcul TPI d√©taill√© -->
        <div class="section">
            <h2>üßÆ Calcul TPI par lot (√† ton prix de vente)</h2>
            <table>
                <thead>
                    <tr>
                        <th>Lot</th>
                        <th>Prix vente</th>
                        <th>Valeur d√©clar√©e</th>
                        <th>+ Forfait 15%</th>
                        <th>√ó Coeff r√©eval.</th>
                        <th>= Prix revient</th>
                        <th>Plus-value</th>
                        <th>- Abatt. 20%</th>
                        <th>PV imposable</th>
                        <th>TPI 20%</th>
                        <th>Cotis. min 3%</th>
                        <th><strong>TPI √† payer</strong></th>
                    </tr>
                </thead>
                <tbody id="tpiTableBody">
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td id="totalPrixVente">-</td>
                        <td colspan="8"></td>
                        <td id="totalCotisMin">-</td>
                        <td id="totalTPI">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- Sc√©nario DGI -->
        <div class="section">
            <h2>‚ö†Ô∏è Sc√©nario : La DGI rectifie le prix</h2>
            <table>
                <thead>
                    <tr>
                        <th>Lot</th>
                        <th>Prix vente d√©clar√©</th>
                        <th>Prix DGI rectifi√©</th>
                        <th>TPI ton prix</th>
                        <th>TPI prix DGI</th>
                        <th><strong>Diff√©rence</strong></th>
                    </tr>
                </thead>
                <tbody id="dgiTableBody">
                </tbody>
                <tfoot>
                    <tr class="total-row">
                        <td><strong>TOTAL</strong></td>
                        <td id="totalVenteDeclare">-</td>
                        <td id="totalVenteDGI">-</td>
                        <td id="totalTPITonPrix">-</td>
                        <td id="totalTPIDGI">-</td>
                        <td id="totalDiffDGI">-</td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- R√©sum√© par personne -->
        <div class="section">
            <h2>üë• TPI √† payer par personne</h2>
            <div class="summary-grid">
                <div class="summary-card danger">
                    <div class="label">Ali (TPI totale)</div>
                    <div class="value" id="tpiAli">-</div>
                    <div class="detail" id="tpiAliDetail">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Amina (TPI totale)</div>
                    <div class="value" id="tpiAmina">-</div>
                    <div class="detail" id="tpiAminaDetail">-</div>
                </div>
                <div class="summary-card">
                    <div class="label">Leila (TPI totale)</div>
                    <div class="value" id="tpiLeila">-</div>
                    <div class="detail" id="tpiLeilaDetail">-</div>
                </div>
            </div>

            <div class="per-person">
                <div class="person-section">
                    <h3>Ali</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Lot</th>
                                <th>Quote-part</th>
                                <th>Valeur</th>
                                <th>TPI √† payer</th>
                                <th>Net apr√®s TPI</th>
                            </tr>
                        </thead>
                        <tbody id="aliDetail"></tbody>
                    </table>
                </div>
                <div class="person-section">
                    <h3>Amina</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Lot</th>
                                <th>Quote-part</th>
                                <th>Valeur</th>
                                <th>TPI √† payer</th>
                                <th>Net apr√®s TPI</th>
                            </tr>
                        </thead>
                        <tbody id="aminaDetail"></tbody>
                    </table>
                </div>
                <div class="person-section">
                    <h3>Leila</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Lot</th>
                                <th>Quote-part</th>
                                <th>Valeur</th>
                                <th>TPI √† payer</th>
                                <th>Net apr√®s TPI</th>
                            </tr>
                        </thead>
                        <tbody id="leilaDetail"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Avertissement -->
        <div class="warning-box">
            <h3>‚ö†Ô∏è Avertissements importants</h3>
            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                <li>Les <strong>coefficients de r√©√©valuation</strong> sont approximatifs. Consultez l'arr√™t√© minist√©riel officiel.</li>
                <li>La <strong>DGI peut rectifier</strong> le prix de vente ET la valeur d√©clar√©e √† la succession/donation.</li>
                <li>Demandez un <strong>avis pr√©alable √† la DGI</strong> pour s√©curiser votre transaction.</li>
                <li>La TPI doit √™tre pay√©e dans les <strong>30 jours</strong> suivant la vente (p√©nalit√© : 10% + 5%/mois).</li>
                <li>Ce simulateur est <strong>indicatif</strong>. Consultez un fiscaliste pour un calcul officiel.</li>
            </ul>
        </div>

        <div class="info-box">
            <h3>üìå Rappel des r√®gles fiscales</h3>
            <ul style="margin-left: 20px; margin-top: 10px; line-height: 1.8;">
                <li><strong>TPI</strong> = 20% de la plus-value</li>
                <li><strong>Cotisation minimale</strong> = 3% du prix de vente (m√™me sans plus-value)</li>
                <li><strong>Forfait frais</strong> = 15% du prix d'acquisition (automatique)</li>
                <li><strong>Abattement dur√©e</strong> = 3% par an au-del√† de 5 ans (max 20%)</li>
                <li><strong>Coefficient r√©√©valuation</strong> = ajuste le prix d'achat selon l'inflation</li>
            </ul>
        </div>
    </div>

    <script>
        // Coefficients de r√©√©valuation approximatifs
        function getCoeffReevaluation(annee, anneeVente) {
            const anciennete = anneeVente - annee;
            // Approximation : ~2% par an en moyenne
            if (anciennete <= 0) return 1;
            if (anciennete >= 30) return 2.5;

            const coefficients = {
                2024: 1.00, 2023: 1.014, 2022: 1.035, 2021: 1.048,
                2020: 1.055, 2019: 1.063, 2018: 1.075, 2017: 1.087,
                2016: 1.104, 2015: 1.120, 2014: 1.125, 2013: 1.145,
                2012: 1.160, 2011: 1.170, 2010: 1.180, 2009: 1.190,
                2008: 1.205, 2007: 1.225, 2006: 1.260, 2005: 1.275,
                2004: 1.295, 2003: 1.310, 2002: 1.325, 2001: 1.345,
                2000: 1.360, 1999: 1.38, 1998: 1.40, 1997: 1.42,
                1996: 1.45, 1995: 1.50, 1994: 1.55, 1993: 1.60,
                1992: 1.65, 1991: 1.70, 1990: 1.80
            };

            if (coefficients[annee]) return coefficients[annee];
            if (annee < 1990) return 1.80 + (1990 - annee) * 0.03;
            return 1;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('fr-FR').format(Math.round(num));
        }

        function calculerTPI(prixVente, valeurDeclaree, anneeAcquisition, anneeVente) {
            const forfait15 = valeurDeclaree * 0.15;
            const coeff = getCoeffReevaluation(anneeAcquisition, anneeVente);
            const prixRevient = (valeurDeclaree + forfait15) * coeff;

            const plusValue = prixVente - prixRevient;

            // Abattement dur√©e : 3% par an au-del√† de 5 ans, max 20%
            const duree = anneeVente - anneeAcquisition;
            let tauxAbattement = 0;
            if (duree > 5) {
                tauxAbattement = Math.min((duree - 5) * 0.03, 0.20);
            }

            const abattement = Math.max(0, plusValue) * tauxAbattement;
            const pvImposable = Math.max(0, plusValue - abattement);

            const tpi20 = pvImposable * 0.20;
            const cotisMin = prixVente * 0.03;

            const tpiAPayer = Math.max(tpi20, cotisMin);

            return {
                prixVente,
                valeurDeclaree,
                forfait15,
                coeff,
                prixRevient,
                plusValue,
                tauxAbattement,
                abattement,
                pvImposable,
                tpi20,
                cotisMin,
                tpiAPayer
            };
        }

        function recalculer() {
            const anneeDonation = parseInt(document.getElementById('anneeDonation').value) || 2000;
            const valeurDonation = parseFloat(document.getElementById('valeurDonation').value) || 200;
            const anneeHeritage = parseInt(document.getElementById('anneeHeritage').value) || 2015;
            const valeurHeritage = parseFloat(document.getElementById('valeurHeritage').value) || 200;
            const prixDGI = parseFloat(document.getElementById('prixDGI').value) || 20000;
            const anneeVente = parseInt(document.getElementById('anneeVente').value) || 2025;

            const lots = [
                {
                    nom: 'Lot 1',
                    type: 'Donation',
                    surface: parseFloat(document.getElementById('surface1').value) || 1577,
                    prix: parseFloat(document.getElementById('prix1').value) || 18000,
                    ali: 1, amina: 0, leila: 0,
                    annee: anneeDonation,
                    valeurM2: valeurDonation
                },
                {
                    nom: 'Lot 2',
                    type: 'H√©ritage',
                    surface: parseFloat(document.getElementById('surface2').value) || 1425,
                    prix: parseFloat(document.getElementById('prix2').value) || 17000,
                    ali: 0, amina: 0.5, leila: 0.5,
                    annee: anneeHeritage,
                    valeurM2: valeurHeritage
                },
                {
                    nom: 'Lot 3',
                    type: 'H√©ritage',
                    surface: parseFloat(document.getElementById('surface3').value) || 1373,
                    prix: parseFloat(document.getElementById('prix3').value) || 17000,
                    ali: 0.5, amina: 0.25, leila: 0.25,
                    annee: anneeHeritage,
                    valeurM2: valeurHeritage
                },
                {
                    nom: 'Lot 4',
                    type: 'H√©ritage',
                    surface: parseFloat(document.getElementById('surface4').value) || 1213,
                    prix: parseFloat(document.getElementById('prix4').value) || 17000,
                    ali: 0.5, amina: 0.25, leila: 0.25,
                    annee: anneeHeritage,
                    valeurM2: valeurHeritage
                }
            ];

            // Calcul des valeurs de base
            let totalSurface = 0;
            let totalValeur = 0;

            lots.forEach((lot, i) => {
                lot.valeurTotale = lot.surface * lot.prix;
                lot.valeurDeclaree = lot.surface * lot.valeurM2;
                totalSurface += lot.surface;
                totalValeur += lot.valeurTotale;

                document.getElementById(`valeur${i+1}`).textContent = formatNumber(lot.valeurTotale) + ' MAD';
            });

            document.getElementById('totalSurface').textContent = formatNumber(totalSurface) + ' m¬≤';
            document.getElementById('totalValeur').textContent = formatNumber(totalValeur) + ' MAD';

            // Calcul TPI par lot
            let tpiTableHTML = '';
            let totalPrixVente = 0;
            let totalTPIAPayer = 0;
            let totalCotisMin = 0;

            const resultats = [];

            lots.forEach((lot, i) => {
                const result = calculerTPI(lot.valeurTotale, lot.valeurDeclaree, lot.annee, anneeVente);
                result.lot = lot;
                resultats.push(result);

                totalPrixVente += result.prixVente;
                totalTPIAPayer += result.tpiAPayer;
                totalCotisMin += result.cotisMin;

                const isCotisMin = result.tpi20 < result.cotisMin;

                tpiTableHTML += `
                    <tr class="${isCotisMin ? 'highlight-orange' : 'highlight'}">
                        <td><strong>${lot.nom}</strong></td>
                        <td>${formatNumber(result.prixVente)}</td>
                        <td>${formatNumber(result.valeurDeclaree)}</td>
                        <td>${formatNumber(result.forfait15)}</td>
                        <td>${result.coeff.toFixed(3)}</td>
                        <td>${formatNumber(result.prixRevient)}</td>
                        <td class="${result.plusValue < 0 ? 'negative' : 'positive'}">${formatNumber(result.plusValue)}</td>
                        <td>${(result.tauxAbattement * 100).toFixed(0)}%</td>
                        <td>${formatNumber(result.pvImposable)}</td>
                        <td>${formatNumber(result.tpi20)}</td>
                        <td>${formatNumber(result.cotisMin)}</td>
                        <td><strong>${formatNumber(result.tpiAPayer)}</strong></td>
                    </tr>
                `;
            });

            document.getElementById('tpiTableBody').innerHTML = tpiTableHTML;
            document.getElementById('totalPrixVente').textContent = formatNumber(totalPrixVente) + ' MAD';
            document.getElementById('totalCotisMin').textContent = formatNumber(totalCotisMin) + ' MAD';
            document.getElementById('totalTPI').textContent = formatNumber(totalTPIAPayer) + ' MAD';

            // Sc√©nario DGI
            let dgiTableHTML = '';
            let totalVenteDeclare = 0;
            let totalVenteDGI = 0;
            let totalTPITonPrix = 0;
            let totalTPIDGI = 0;

            lots.forEach((lot, i) => {
                const prixVenteDeclare = lot.valeurTotale;
                const prixVenteDGI = lot.surface * prixDGI;

                const tpiTonPrix = resultats[i].tpiAPayer;

                const resultDGI = calculerTPI(prixVenteDGI, lot.valeurDeclaree, lot.annee, anneeVente);
                const tpiDGI = resultDGI.tpiAPayer;

                const diff = tpiDGI - tpiTonPrix;

                totalVenteDeclare += prixVenteDeclare;
                totalVenteDGI += prixVenteDGI;
                totalTPITonPrix += tpiTonPrix;
                totalTPIDGI += tpiDGI;

                dgiTableHTML += `
                    <tr>
                        <td><strong>${lot.nom}</strong></td>
                        <td>${formatNumber(prixVenteDeclare)}</td>
                        <td>${formatNumber(prixVenteDGI)}</td>
                        <td>${formatNumber(tpiTonPrix)}</td>
                        <td>${formatNumber(tpiDGI)}</td>
                        <td class="${diff > 0 ? 'negative' : ''}"><strong>+${formatNumber(diff)}</strong></td>
                    </tr>
                `;
            });

            document.getElementById('dgiTableBody').innerHTML = dgiTableHTML;
            document.getElementById('totalVenteDeclare').textContent = formatNumber(totalVenteDeclare) + ' MAD';
            document.getElementById('totalVenteDGI').textContent = formatNumber(totalVenteDGI) + ' MAD';
            document.getElementById('totalTPITonPrix').textContent = formatNumber(totalTPITonPrix) + ' MAD';
            document.getElementById('totalTPIDGI').textContent = formatNumber(totalTPIDGI) + ' MAD';
            document.getElementById('totalDiffDGI').textContent = '+' + formatNumber(totalTPIDGI - totalTPITonPrix) + ' MAD';

            // TPI par personne
            let tpiAli = 0, tpiAmina = 0, tpiLeila = 0;
            let aliHTML = '', aminaHTML = '', leilaHTML = '';

            resultats.forEach((result, i) => {
                const lot = result.lot;

                // Ali
                if (lot.ali > 0) {
                    const tpi = result.tpiAPayer * lot.ali;
                    const valeur = result.prixVente * lot.ali;
                    tpiAli += tpi;
                    aliHTML += `
                        <tr>
                            <td>${lot.nom}</td>
                            <td>${(lot.ali * 100)}%</td>
                            <td>${formatNumber(valeur)} MAD</td>
                            <td class="negative">${formatNumber(tpi)} MAD</td>
                            <td class="positive">${formatNumber(valeur - tpi)} MAD</td>
                        </tr>
                    `;
                }

                // Amina
                if (lot.amina > 0) {
                    const tpi = result.tpiAPayer * lot.amina;
                    const valeur = result.prixVente * lot.amina;
                    tpiAmina += tpi;
                    aminaHTML += `
                        <tr>
                            <td>${lot.nom}</td>
                            <td>${(lot.amina * 100)}%</td>
                            <td>${formatNumber(valeur)} MAD</td>
                            <td class="negative">${formatNumber(tpi)} MAD</td>
                            <td class="positive">${formatNumber(valeur - tpi)} MAD</td>
                        </tr>
                    `;
                }

                // Leila
                if (lot.leila > 0) {
                    const tpi = result.tpiAPayer * lot.leila;
                    const valeur = result.prixVente * lot.leila;
                    tpiLeila += tpi;
                    leilaHTML += `
                        <tr>
                            <td>${lot.nom}</td>
                            <td>${(lot.leila * 100)}%</td>
                            <td>${formatNumber(valeur)} MAD</td>
                            <td class="negative">${formatNumber(tpi)} MAD</td>
                            <td class="positive">${formatNumber(valeur - tpi)} MAD</td>
                        </tr>
                    `;
                }
            });

            // Totaux par personne
            const valeurAli = lots.reduce((sum, lot) => sum + lot.valeurTotale * lot.ali, 0);
            const valeurAmina = lots.reduce((sum, lot) => sum + lot.valeurTotale * lot.amina, 0);
            const valeurLeila = lots.reduce((sum, lot) => sum + lot.valeurTotale * lot.leila, 0);

            document.getElementById('tpiAli').textContent = formatNumber(tpiAli) + ' MAD';
            document.getElementById('tpiAliDetail').textContent = `Net: ${formatNumber(valeurAli - tpiAli)} MAD`;

            document.getElementById('tpiAmina').textContent = formatNumber(tpiAmina) + ' MAD';
            document.getElementById('tpiAminaDetail').textContent = `Net: ${formatNumber(valeurAmina - tpiAmina)} MAD`;

            document.getElementById('tpiLeila').textContent = formatNumber(tpiLeila) + ' MAD';
            document.getElementById('tpiLeilaDetail').textContent = `Net: ${formatNumber(valeurLeila - tpiLeila)} MAD`;

            // Tableaux d√©taill√©s
            aliHTML += `<tr class="total-row"><td><strong>TOTAL</strong></td><td></td><td>${formatNumber(valeurAli)} MAD</td><td>${formatNumber(tpiAli)} MAD</td><td>${formatNumber(valeurAli - tpiAli)} MAD</td></tr>`;
            aminaHTML += `<tr class="total-row"><td><strong>TOTAL</strong></td><td></td><td>${formatNumber(valeurAmina)} MAD</td><td>${formatNumber(tpiAmina)} MAD</td><td>${formatNumber(valeurAmina - tpiAmina)} MAD</td></tr>`;
            leilaHTML += `<tr class="total-row"><td><strong>TOTAL</strong></td><td></td><td>${formatNumber(valeurLeila)} MAD</td><td>${formatNumber(tpiLeila)} MAD</td><td>${formatNumber(valeurLeila - tpiLeila)} MAD</td></tr>`;

            document.getElementById('aliDetail').innerHTML = aliHTML;
            document.getElementById('aminaDetail').innerHTML = aminaHTML;
            document.getElementById('leilaDetail').innerHTML = leilaHTML;
        }

        // Calcul initial
        recalculer();
    </script>
</body>
</html>
